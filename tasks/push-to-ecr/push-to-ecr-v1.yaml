apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: push-to-ecr
  labels:
    app.kubernetes.io/version: "1.0.0"
spec:
  description: Build and push container image to AWS ECR using Kaniko

  params:
    - name: image
      description: Full ECR image reference (registry/repository:tag)
    - name: dockerfile
      description: Path to the Dockerfile to build
      default: ./Dockerfile
    - name: context
      description: The build context used by Kaniko
      default: ./
    - name: aws-region
      description: AWS region where ECR repository exists
      default: us-east-1
    - name: extra-args
      type: array
      default: []
      description: Extra arguments to pass to kaniko

  workspaces:
    - name: source
      description: Holds the context and Dockerfile
    - name: aws-credentials
      description: AWS credentials for ECR authentication

  results:
    - name: IMAGE_DIGEST
      description: Digest of the image just built
    - name: IMAGE_URL
      description: URL of the image just built

  steps:
    - name: ecr-login
      image: amazon/aws-cli:2.13.25
      workingDir: $(workspaces.source.path)
      script: |
        #!/usr/bin/env bash
        set -e

        # Read AWS credentials from workspace (mounted secret)
        if [ -f "$(workspaces.aws-credentials.path)/aws_access_key_id" ]; then
          export AWS_ACCESS_KEY_ID=$(cat $(workspaces.aws-credentials.path)/aws_access_key_id)
          export AWS_SECRET_ACCESS_KEY=$(cat $(workspaces.aws-credentials.path)/aws_secret_access_key)
        else
          echo "Error: AWS credentials not found in workspace"
          exit 1
        fi
        export AWS_DEFAULT_REGION=$(params.aws-region)

        echo "Logging into ECR..."
        aws ecr get-login-password --region $(params.aws-region) > /workspace/ecr-token

        REGISTRY=$(echo "$(params.image)" | cut -d'/' -f1)

        # Create docker config for Kaniko
        mkdir -p /kaniko/.docker
        cat > /kaniko/.docker/config.json <<EOF
        {
          "auths": {
            "${REGISTRY}": {
              "auth": "$(echo -n "AWS:$(cat /workspace/ecr-token)" | base64 | tr -d '\n')"
            }
          }
        }
        EOF

        echo "ECR login successful"
      volumeMounts:
        - name: kaniko-secret
          mountPath: /kaniko/.docker

    - name: build-and-push
      workingDir: $(workspaces.source.path)
      image: gcr.io/kaniko-project/executor:v1.23.2
      args:
        - $(params.extra-args[*])
        - --dockerfile=$(params.dockerfile)
        - --context=$(workspaces.source.path)/$(params.context)
        - --destination=$(params.image)
        - --digest-file=$(results.IMAGE_DIGEST.path)
      # Kaniko requires root to build container images
      # This is acceptable as it only builds, doesn't execute arbitrary code
      securityContext:
        runAsUser: 0
      volumeMounts:
        - name: kaniko-secret
          mountPath: /kaniko/.docker
          readOnly: true

    - name: write-url
      image: docker.io/library/bash:5.2.21
      script: |
        set -e
        image="$(params.image)"
        echo -n "${image}" | tee "$(results.IMAGE_URL.path)"

  volumes:
    - name: kaniko-secret
      emptyDir: {}
